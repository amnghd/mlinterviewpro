{"type":"excalidraw","version":2,"source":"https://app.excalidraw.com","metadata":{"id":"9eZt24tfWUJ","workspace":"6lsqOkFWqjK","name":"Youtube Video Search","created":"2025-10-14T19:58:26.517Z","updated":"2025-10-14T22:24:29.734Z","collection":null,"creator":"Alx6QpYT9Vj","updater":"Alx6QpYT9Vj","isPrivate":true,"pinned":false},"elements":[{"id":"5uTLwqS3IP9Xoao1BWGjM","type":"text","x":149.875,"y":229.4765625,"width":1267.0592041015625,"height":3650,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a0","roundness":null,"seed":1945055115,"version":5535,"versionNonce":1654700779,"isDeleted":false,"boundElements":[],"updated":1760477772206,"link":null,"locked":false,"text":"Youtube Video Search\n\nCQ: \n- What is the size of catalogue?\n- is this a text search?\n- which language is the search?\n- is this personalized or more related to query to video match?\n- what is our latency budget?\n- what is QPS?\n- how fast new users, new content are added?\n- do we have training data available? previous query vs video?\n\nHigh level design:\n- Design a system that get a query, understands it and return a list of relevant videos (Sorted by similarity) with 150ms budget.\n- This does not have to be personalized.\n- Metrics user engagement (video watch time, completion rate) weighted and multitask\n- Guardrail on churn, and user report\n- Structure is a two tower model (query, video) \n - results should be diverse and fresh\n- high level architecture: query understanding and expansion, retrival, reranking\n\n\nData generation:\n- Labels: \n-- we have tons of interaction data=> no need for manual data\n-- positive: user watch time, user completion rate, on impression\n-- negative user impressed watch, user not completed (For each task) - in session negative (during session)\n-- if we have to select (user watch time * user completion rate) for long term\n-- click is click baity (can be aded to the mix with very low weight o improve transfer learning and representation learning)\n\n- Data engineering:\n-- This is not persnalized:\n-- query + fanout\n\n\n- catalouge : video\n- video id\n- video genre\n- video description\n- video # like\n- video #  impression\n- video comments \n- video age (for fresh results)\n- video channel id\n- video channel genre\n- video channel num subscriptin\n\nfeauture engineering\n- query:\n-- SLM: generate query fanout, query rewrite, and autocorrection\n-- send multiple queries to the retrival\n-- can get the encoder head output (or another finetuned SLM, or Distlled bert)\n-- for encoder head (cleaning: normalization,  tokenization, token to ids through hashing (Cheaper no storage)))\n-- for text we can use embedding layer, word2vec (CBOW, skipogram)\n\n\n- video\n- video id (embedding)\n- video contnent (cleaning, decoding to frame, noramization, denoising)=> simclr, autoencoder\n-- video level models (3d transformer), or frame base (first one very expensive) - but done offline\n\n- video transcription: BERT\n- video genre (one hot)\n- video description (BERT, distilled bert)\n- video # like (bucketized, maybe after transform, it is right skwed)\n- video #  impression (bucketized)\n- video comments (BERT)\n- video age (for fresh results) (bucketized)\n- video channel id (embedding)\n- video channel genre (bucketized)\n- video channel num subscriptin\n\n\nModel:\n- collab filtering? this is not really recommendation system so no\n- two tower:\n-- one tower for video, one tower for query\n- loss: contrastive loss (for all in batch negatives and single positive)\n- softmax loss (single positive, all others negative)\n- - if we want to use softmax (we need to use boolean -> completion, 25%)\n- - we can also use multi task learning with pairs of positive and negatives (less ranked)\n- output embedding\n-- MLP on each (maybe DCN if we think feature crosses will help)\n-- we can have in session neba\n-- run ANN (SCANN, LSH, FB ANN), assure log n retrival\n\n\n\nEvaluation\noffline:\n- recall @k (on whole catalouge - not possible)\n- MRR only first is important \n- we rank them too so MAP seems better (score is click, completion)\n\nonline:\n- completion rate\n- good click\n- 25%, 50%\n\n- sliced by country\n- sliced by language\n\n\n\nDeployment\n- shadowing => offline, make sure results are reasonable\n- canarying => 1DC with gaurdrail auto removing traffic\n- experiment A/B test\n- holdback\n- full launch\n\n\nServing\n- model is already cheap,\n- we can also work with making this personalized (adding user features to query tower)\n\n\n\nAdvanced topics:\n- continual training\n-- on drift (# new videos)\n-- daily, hourly, (study on impact on quality + training cost)\n-- continual learning ( new batch of data, new training, new check point)\n-- possibility of catastrophic forgetting (assure low learning rate)\n--- log qualiry\n\n\n- freshness, diversity\n-- fresh models, exploring, candidate generator for trendy, new data, \n- diversity, penalize similarirty (gaurdrail on quality loss)\n\n\n\nMonitoring\n- data dstribution (sepcially new IDs)\n- quality (spacaillay for continueal learning)\n- losses\n- engagement metrics \n- latency, request count, faulure count\n\n\n\n\n\n\n","fontSize":20,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Youtube Video Search\n\nCQ: \n- What is the size of catalogue?\n- is this a text search?\n- which language is the search?\n- is this personalized or more related to query to video match?\n- what is our latency budget?\n- what is QPS?\n- how fast new users, new content are added?\n- do we have training data available? previous query vs video?\n\nHigh level design:\n- Design a system that get a query, understands it and return a list of relevant videos (Sorted by similarity) with 150ms budget.\n- This does not have to be personalized.\n- Metrics user engagement (video watch time, completion rate) weighted and multitask\n- Guardrail on churn, and user report\n- Structure is a two tower model (query, video) \n - results should be diverse and fresh\n- high level architecture: query understanding and expansion, retrival, reranking\n\n\nData generation:\n- Labels: \n-- we have tons of interaction data=> no need for manual data\n-- positive: user watch time, user completion rate, on impression\n-- negative user impressed watch, user not completed (For each task) - in session negative (during session)\n-- if we have to select (user watch time * user completion rate) for long term\n-- click is click baity (can be aded to the mix with very low weight o improve transfer learning and representation learning)\n\n- Data engineering:\n-- This is not persnalized:\n-- query + fanout\n\n\n- catalouge : video\n- video id\n- video genre\n- video description\n- video # like\n- video #  impression\n- video comments \n- video age (for fresh results)\n- video channel id\n- video channel genre\n- video channel num subscriptin\n\nfeauture engineering\n- query:\n-- SLM: generate query fanout, query rewrite, and autocorrection\n-- send multiple queries to the retrival\n-- can get the encoder head output (or another finetuned SLM, or Distlled bert)\n-- for encoder head (cleaning: normalization,  tokenization, token to ids through hashing (Cheaper no storage)))\n-- for text we can use embedding layer, word2vec (CBOW, skipogram)\n\n\n- video\n- video id (embedding)\n- video contnent (cleaning, decoding to frame, noramization, denoising)=> simclr, autoencoder\n-- video level models (3d transformer), or frame base (first one very expensive) - but done offline\n\n- video transcription: BERT\n- video genre (one hot)\n- video description (BERT, distilled bert)\n- video # like (bucketized, maybe after transform, it is right skwed)\n- video #  impression (bucketized)\n- video comments (BERT)\n- video age (for fresh results) (bucketized)\n- video channel id (embedding)\n- video channel genre (bucketized)\n- video channel num subscriptin\n\n\nModel:\n- collab filtering? this is not really recommendation system so no\n- two tower:\n-- one tower for video, one tower for query\n- loss: contrastive loss (for all in batch negatives and single positive)\n- softmax loss (single positive, all others negative)\n- - if we want to use softmax (we need to use boolean -> completion, 25%)\n- - we can also use multi task learning with pairs of positive and negatives (less ranked)\n- output embedding\n-- MLP on each (maybe DCN if we think feature crosses will help)\n-- we can have in session neba\n-- run ANN (SCANN, LSH, FB ANN), assure log n retrival\n\n\n\nEvaluation\noffline:\n- recall @k (on whole catalouge - not possible)\n- MRR only first is important \n- we rank them too so MAP seems better (score is click, completion)\n\nonline:\n- completion rate\n- good click\n- 25%, 50%\n\n- sliced by country\n- sliced by language\n\n\n\nDeployment\n- shadowing => offline, make sure results are reasonable\n- canarying => 1DC with gaurdrail auto removing traffic\n- experiment A/B test\n- holdback\n- full launch\n\n\nServing\n- model is already cheap,\n- we can also work with making this personalized (adding user features to query tower)\n\n\n\nAdvanced topics:\n- continual training\n-- on drift (# new videos)\n-- daily, hourly, (study on impact on quality + training cost)\n-- continual learning ( new batch of data, new training, new check point)\n-- possibility of catastrophic forgetting (assure low learning rate)\n--- log qualiry\n\n\n- freshness, diversity\n-- fresh models, exploring, candidate generator for trendy, new data, \n- diversity, penalize similarirty (gaurdrail on quality loss)\n\n\n\nMonitoring\n- data dstribution (sepcially new IDs)\n- quality (spacaillay for continueal learning)\n- losses\n- engagement metrics \n- latency, request count, faulure count\n\n\n\n\n\n\n","autoResize":true,"lineHeight":1.25},{"id":"h0hf87uMPMOcKKRUQ1Tsl","type":"rectangle","x":1570,"y":472.00390625,"width":185.6953125,"height":138.828125,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a2","roundness":{"type":3},"seed":299193451,"version":80,"versionNonce":1922807557,"isDeleted":false,"boundElements":[{"type":"text","id":"M15_xfR5irl_g2JirpYSq"},{"id":"GOxviblUBuO5Zv39cGUXJ","type":"arrow"}],"updated":1760474037791,"link":null,"locked":false},{"id":"M15_xfR5irl_g2JirpYSq","type":"text","x":1619.4976959228516,"y":528.91796875,"width":86.69992065429688,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a3","roundness":null,"seed":947581477,"version":23,"versionNonce":1012274117,"isDeleted":false,"boundElements":[],"updated":1760474007559,"link":null,"locked":false,"text":"Retrieval","fontSize":20,"fontFamily":5,"textAlign":"center","verticalAlign":"middle","containerId":"h0hf87uMPMOcKKRUQ1Tsl","originalText":"Retrieval","autoResize":true,"lineHeight":1.25},{"id":"ibwSnQ0RFX5nPhSLV9xQn","type":"rectangle","x":1814.82421875,"y":473.56640625,"width":199.45703125,"height":136.28515625,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a4","roundness":{"type":3},"seed":844998277,"version":114,"versionNonce":262623051,"isDeleted":false,"boundElements":[{"type":"text","id":"wS87bt8M_RRZ89ixmOtT-"},{"id":"g8bMlr2DbLxVx10CozQvP","type":"arrow"}],"updated":1760474021702,"link":null,"locked":false},{"id":"wS87bt8M_RRZ89ixmOtT-","type":"text","x":1868.1527862548828,"y":529.208984375,"width":92.79989624023438,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a5","roundness":null,"seed":362413195,"version":11,"versionNonce":979126635,"isDeleted":false,"boundElements":[],"updated":1760474013355,"link":null,"locked":false,"text":"Re-ranker","fontSize":20,"fontFamily":5,"textAlign":"center","verticalAlign":"middle","containerId":"ibwSnQ0RFX5nPhSLV9xQn","originalText":"Re-ranker","autoResize":true,"lineHeight":1.25},{"id":"TugHAbeHKejAYmtVucqcE","type":"arrow","x":1754.65625,"y":534.27734375,"width":61.8828125,"height":1.80859375,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a6","roundness":{"type":2},"seed":467872427,"version":43,"versionNonce":568519781,"isDeleted":false,"boundElements":[],"updated":1760474015858,"link":null,"locked":false,"points":[[0,0],[61.8828125,1.80859375]],"lastCommittedPoint":null,"startBinding":null,"endBinding":null,"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"g8bMlr2DbLxVx10CozQvP","type":"arrow","x":2015.8125,"y":532.34765625,"width":100.91015625,"height":0.68359375,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a8","roundness":{"type":2},"seed":1447974661,"version":23,"versionNonce":471473323,"isDeleted":false,"boundElements":[],"updated":1760474021702,"link":null,"locked":false,"points":[[0,0],[100.91015625,-0.68359375]],"lastCommittedPoint":null,"startBinding":{"elementId":"ibwSnQ0RFX5nPhSLV9xQn","focus":-0.12606214880839614,"gap":1.53125},"endBinding":null,"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"iVFaZcFvJ4XY8Eb0r_AiR","type":"rectangle","x":1583.26953125,"y":265.15234375,"width":153.98046875,"height":147.921875,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a9","roundness":{"type":3},"seed":12016261,"version":193,"versionNonce":501845125,"isDeleted":false,"boundElements":[{"id":"GOxviblUBuO5Zv39cGUXJ","type":"arrow"},{"type":"text","id":"wlJlblocMWlaJ79yVb3Xi"}],"updated":1760474038485,"link":null,"locked":false},{"id":"wlJlblocMWlaJ79yVb3Xi","type":"text","x":1592.6998291015625,"y":289.11328125,"width":135.119873046875,"height":100,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a9V","roundness":null,"seed":1186551723,"version":56,"versionNonce":2135825067,"isDeleted":false,"boundElements":[],"updated":1760474046602,"link":null,"locked":false,"text":"Query\nunderstanding\nand query\nexpansion","fontSize":20,"fontFamily":5,"textAlign":"center","verticalAlign":"middle","containerId":"iVFaZcFvJ4XY8Eb0r_AiR","originalText":"Query understanding and query expansion","autoResize":true,"lineHeight":1.25},{"id":"GOxviblUBuO5Zv39cGUXJ","type":"arrow","x":1663.9765625,"y":414.9375,"width":0,"height":48.7265625,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"aA","roundness":{"type":2},"seed":1626340139,"version":28,"versionNonce":1025471397,"isDeleted":false,"boundElements":[],"updated":1760474037791,"link":null,"locked":false,"points":[[0,0],[0,48.7265625]],"lastCommittedPoint":null,"startBinding":{"elementId":"iVFaZcFvJ4XY8Eb0r_AiR","focus":-0.04827621197899504,"gap":1.86328125},"endBinding":{"elementId":"h0hf87uMPMOcKKRUQ1Tsl","focus":0.012158694097353479,"gap":8.33984375},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"dqsHyVwh6bpVrF-d1Unpr","type":"arrow","x":1658.81640625,"y":163.15234375,"width":0.7421875,"height":105.9375,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"aB","roundness":{"type":2},"seed":1426172907,"version":47,"versionNonce":847585765,"isDeleted":false,"boundElements":[],"updated":1760474049979,"link":null,"locked":false,"points":[[0,0],[-0.7421875,105.9375]],"lastCommittedPoint":null,"startBinding":null,"endBinding":null,"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"Z8EoW5wGDlv_KJCilRnmS","type":"text","x":1641,"y":127,"width":40.799957275390625,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"aC","roundness":null,"seed":344248325,"version":6,"versionNonce":1485384933,"isDeleted":false,"boundElements":[],"updated":1760474052353,"link":null,"locked":false,"text":"user","fontSize":20,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"user","autoResize":true,"lineHeight":1.25}],"appState":{"viewBackgroundColor":"#ffffff","lockedMultiSelections":{}},"files":{}}