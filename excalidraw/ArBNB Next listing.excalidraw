{"type":"excalidraw","version":2,"source":"https://app.excalidraw.com","metadata":{"id":"9dDV94LgqwK","workspace":"6lsqOkFWqjK","name":"ArBNB Next listing","created":"2025-10-29T17:44:29.706Z","updated":"2025-10-29T21:54:45.250Z","collection":null,"creator":"Alx6QpYT9Vj","updater":"Alx6QpYT9Vj","isPrivate":true,"pinned":false},"elements":[{"id":"-jfx84slGIlZ_GhbQROBR","type":"text","x":322.604898854656,"y":328.890625,"width":1646.998779296875,"height":3900,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a0","roundness":null,"seed":2127502116,"version":138,"versionNonce":1193613468,"isDeleted":false,"boundElements":[],"updated":1761774881125,"link":null,"locked":false,"text":"Airbnb — Next-Listing Prediction (Session-based Sequential RecSys)\n\n\nCQ\n\nSurface: in-session search/browse (not email/homepage)?\n\nKPI: booking lift (primary), engaged view (≥30s), wishlist as auxiliaries; guardrails: bounce-after-click, complaint rate.\n\nLatency: ≤150 ms end-to-end; ≤70 ms heavy ranker; ≤30 ms retrieval.\n\nSession signals available: query edits, map pans/zooms, filter toggles, detail-views, dwell, add-to-wishlist?\n\nCatalogue scale: multi-country, multi-lingual; cold-start listings?\n\nPersonalization vs pure sessionization: allow short user-history as context?\n\nCandidate budget: K≈800–1500 from retrieval into ranker/reranker.\n\n\n\n\nHigh level\n\nGoal: predict the next listing interaction in the current session and rank a slate that maximizes booking-aligned utility.\n\nThree-stage pipeline: Retrieval (EBR/two-tower) → Heavy Ranker (MMOE+DCNv2) → Reranker (diversity/freshness/fairness).\n\nCore idea: sequence modeling over the user’s in-session events to capture short-term intent drift (queries, filter flips, viewed listings).\n\n\nData construction\n\nLabeling\n\nPointwise labels per impressed candidate: {book, wishlist, click/long-view}. Weighted composite for offline ranking; booking remains primary online.\n\nSessions\n\nBuild sessions by inactivity gap (e.g., 30 min) or product boundary (new search). Create strided windows over the event stream to form (context→next-item) pairs.\n\nNegatives\n\nIn-session impressions with no interaction; keep explicit short bounces as hard negatives. Downsample majority.\n\nTemporal split\n\n\n\nTrain on Q(t), test on Q(t+1) to avoid leakage; region-aware slicing.\n\n\n\nFeature engineering\n\nSequence tokens (ordered by time with time-delta):\n\nViewed listing IDs, map movements, filter toggles, query rewrites, dwell buckets, wishlist events. (IDs mapped to embeddings; include time-gap/positional encodings.)\n\nUser (short history)\n\nCountry, device cluster, price-band cluster, recent bookings/wishlists (small window), seq-embedding from prior sessions if allowed.\n\nListing\n\nListing ID embedding; text (DistilBERT) and image embeddings (SimCLR/CLIP) precomputed; location cell, amenities, price, host quality.\n\nRequest/context\n\nDOW/TOD, lead-time, LOS, language, device, viewport features.\n\nCross features\n\nUser×Listing price alignment, amenity overlap, POI distance; position feature for bias analysis.\n\nFeature store\n\nStatic vs dynamic with TTL; cache high-fanout features; maintain strict train/serve parity.\n\n\n\nRetrieval (recap)\n\nTwo-tower (query/session embedding vs listing embedding) + ANN; keeps recall high under latency.\n\nHeavy Ranker (sequence-aware)\n\nBackbone: Transformer encoder (SASRec/NextItNet-style) over session tokens → session embedding; fuse with candidate listing features via cross-attn or late fusion.\n\nTrunk: DNN with DCNv2 for feature crosses; MMOE heads for {book, wishlist, click, long-view}.\n\nLoss: weighted BCE\n\nReranker\n\nFreshness boost (new listings), diversity via cosine-similarity penalty among top-k, popularity penalty; near-duplicate suppression.\n\n\n\n\nTraining\n\nSampling: negative downsampling (≈10:1), maintain hard negatives (short bounces).\n\nRegularization: dropout, weight decay; label smoothing on click.\n\nGradient balancing for MTL to prevent click dominating booking.\n\nContinual learning: daily retrains + drift-triggered refresh; LR decay to avoid catastrophic forgetting.\n\n\n\n\nEvaluation\n\nOffline\n\nNDCG@k on composite relevance; per-head AUC/PR-AUC; calibration (Brier/ECE).\n\nDiversity: mean pairwise cosine distance among top-k slate.\n\nOnline\n\nBooking rate ↑, engaged view ↑, wishlist rate ↑, session revenue ↑; guardrails: complaints, churn, latency.\n\n\n\n\nServing\n\nBudget split (example): Retrieval 30 ms + Sequence-aware Ranker 70 ms + Reranker 30 ms.\n\nEfficiency: distill heavy ranker to light ranker for spikes; AQT/quantization; feature hydration caching.\n\nPersonalization scope: primarily session-based, optionally enrich with short user history when available.\n\n\n\n\nDeployment & monitoring\n\nShadow → canary → A/B → holdback; auto-rollback on guardrails.\n\nMonitors: NDCG drift, PR-AUC, calibration drift; system p99 latency, QPS; feature staleness %, hydration failures.\n\n\n\nBias / cold-start / exploration\n\nPosition bias: include slot index; run equal-position logging studies.\n\nPopularity bias: apply popularity penalty in reranker + small ε-greedy exploration.\n\nCold-start listing: lean on content embeddings (text/image) in ranker; content-based retrieval path for recall.\n\nCold-start session/user: cluster-based priors + trending/fresh seeds.","fontSize":20,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Airbnb — Next-Listing Prediction (Session-based Sequential RecSys)\n\n\nCQ\n\nSurface: in-session search/browse (not email/homepage)?\n\nKPI: booking lift (primary), engaged view (≥30s), wishlist as auxiliaries; guardrails: bounce-after-click, complaint rate.\n\nLatency: ≤150 ms end-to-end; ≤70 ms heavy ranker; ≤30 ms retrieval.\n\nSession signals available: query edits, map pans/zooms, filter toggles, detail-views, dwell, add-to-wishlist?\n\nCatalogue scale: multi-country, multi-lingual; cold-start listings?\n\nPersonalization vs pure sessionization: allow short user-history as context?\n\nCandidate budget: K≈800–1500 from retrieval into ranker/reranker.\n\n\n\n\nHigh level\n\nGoal: predict the next listing interaction in the current session and rank a slate that maximizes booking-aligned utility.\n\nThree-stage pipeline: Retrieval (EBR/two-tower) → Heavy Ranker (MMOE+DCNv2) → Reranker (diversity/freshness/fairness).\n\nCore idea: sequence modeling over the user’s in-session events to capture short-term intent drift (queries, filter flips, viewed listings).\n\n\nData construction\n\nLabeling\n\nPointwise labels per impressed candidate: {book, wishlist, click/long-view}. Weighted composite for offline ranking; booking remains primary online.\n\nSessions\n\nBuild sessions by inactivity gap (e.g., 30 min) or product boundary (new search). Create strided windows over the event stream to form (context→next-item) pairs.\n\nNegatives\n\nIn-session impressions with no interaction; keep explicit short bounces as hard negatives. Downsample majority.\n\nTemporal split\n\n\n\nTrain on Q(t), test on Q(t+1) to avoid leakage; region-aware slicing.\n\n\n\nFeature engineering\n\nSequence tokens (ordered by time with time-delta):\n\nViewed listing IDs, map movements, filter toggles, query rewrites, dwell buckets, wishlist events. (IDs mapped to embeddings; include time-gap/positional encodings.)\n\nUser (short history)\n\nCountry, device cluster, price-band cluster, recent bookings/wishlists (small window), seq-embedding from prior sessions if allowed.\n\nListing\n\nListing ID embedding; text (DistilBERT) and image embeddings (SimCLR/CLIP) precomputed; location cell, amenities, price, host quality.\n\nRequest/context\n\nDOW/TOD, lead-time, LOS, language, device, viewport features.\n\nCross features\n\nUser×Listing price alignment, amenity overlap, POI distance; position feature for bias analysis.\n\nFeature store\n\nStatic vs dynamic with TTL; cache high-fanout features; maintain strict train/serve parity.\n\n\n\nRetrieval (recap)\n\nTwo-tower (query/session embedding vs listing embedding) + ANN; keeps recall high under latency.\n\nHeavy Ranker (sequence-aware)\n\nBackbone: Transformer encoder (SASRec/NextItNet-style) over session tokens → session embedding; fuse with candidate listing features via cross-attn or late fusion.\n\nTrunk: DNN with DCNv2 for feature crosses; MMOE heads for {book, wishlist, click, long-view}.\n\nLoss: weighted BCE\n\nReranker\n\nFreshness boost (new listings), diversity via cosine-similarity penalty among top-k, popularity penalty; near-duplicate suppression.\n\n\n\n\nTraining\n\nSampling: negative downsampling (≈10:1), maintain hard negatives (short bounces).\n\nRegularization: dropout, weight decay; label smoothing on click.\n\nGradient balancing for MTL to prevent click dominating booking.\n\nContinual learning: daily retrains + drift-triggered refresh; LR decay to avoid catastrophic forgetting.\n\n\n\n\nEvaluation\n\nOffline\n\nNDCG@k on composite relevance; per-head AUC/PR-AUC; calibration (Brier/ECE).\n\nDiversity: mean pairwise cosine distance among top-k slate.\n\nOnline\n\nBooking rate ↑, engaged view ↑, wishlist rate ↑, session revenue ↑; guardrails: complaints, churn, latency.\n\n\n\n\nServing\n\nBudget split (example): Retrieval 30 ms + Sequence-aware Ranker 70 ms + Reranker 30 ms.\n\nEfficiency: distill heavy ranker to light ranker for spikes; AQT/quantization; feature hydration caching.\n\nPersonalization scope: primarily session-based, optionally enrich with short user history when available.\n\n\n\n\nDeployment & monitoring\n\nShadow → canary → A/B → holdback; auto-rollback on guardrails.\n\nMonitors: NDCG drift, PR-AUC, calibration drift; system p99 latency, QPS; feature staleness %, hydration failures.\n\n\n\nBias / cold-start / exploration\n\nPosition bias: include slot index; run equal-position logging studies.\n\nPopularity bias: apply popularity penalty in reranker + small ε-greedy exploration.\n\nCold-start listing: lean on content embeddings (text/image) in ranker; content-based retrieval path for recall.\n\nCold-start session/user: cluster-based priors + trending/fresh seeds.","autoResize":true,"lineHeight":1.25}],"appState":{"viewBackgroundColor":"#ffffff","lockedMultiSelections":{}},"files":{}}