{"type":"excalidraw","version":2,"source":"https://app.excalidraw.com","metadata":{"id":"7PdRM9ETsmE","workspace":"6lsqOkFWqjK","name":"YT Video Recommendation","created":"2025-10-14T19:58:12.097Z","updated":"2025-10-14T22:19:40.271Z","collection":null,"creator":"Alx6QpYT9Vj","updater":"Alx6QpYT9Vj","isPrivate":true,"pinned":false},"elements":[{"id":"cLRTkaFGEjBQKh7Ip4tVf","type":"text","x":116.62890625,"y":207.12109375,"width":1382.158935546875,"height":3650,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":2,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"a0","roundness":null,"seed":1176683467,"version":5390,"versionNonce":11067205,"isDeleted":false,"boundElements":[],"updated":1760480376205,"link":null,"locked":false,"text":"Design YT recommendation system:\n\nCQ:\n- How big is the catalouge? 1B\n- Multi lingual? yes\n- Is there a context (like video page), or is it on feed? Feed\n- Latency budget? 200ms\n- QPS? 50 k QPS\n- KPI: Video completion rate guardrail on churn rate?\n- Multi lingual videos. Yes\n- User video interactions (like, comment, watch, watch ratio, click,etc) available? Yes\n\nHigh level:\n- maximize user engagement on video catalogue\n- KPI watch time (dwell time- relevant (weighted sum of important signals)), guardrail on churn, \n- fast\n\nData engineering:\n- label: relevant metric (weighted sum of metrics) (give score to each)\n- w1 x like, w2 x comment sentiment, w3 x share, w4 x watch time, w5 x dwell time\n- negative samples, in session impressed by not engaged (per task)\n\n- features:\n-- user: user age, user demographic, user history, user embeddings (from a seperate user sequence model)\n-- user search history (embedding of queries aggregated), ids of videos (liked, shared, tc) also aggregated)\n\n- user id, user clusters (of video genre), user previous video id s aggreated embeding, \n-\nrequest:\n- context \n- TOTD, DOTW, device id,network id, phone type, phone version, \n\n\n video\n- video id (embedding)\n- video contnent (cleaning, decoding to frame, noramization, denoising)=> simclr, autoencoder\n-- video level models (3d transformer), or frame base (first one very expensive) - but done offline\n\n- video transcription: BERT\n- video genre (one hot)\n- video description (BERT, distilled bert)\n- video # like (bucketized, maybe after transform, it is right skwed)\n- video #  impression (bucketized)\n- video comments (BERT)\n- video age (for fresh results) (bucketized)\n- video channel id (embedding)\n- video channel genre (bucketized)\n- video channel num subscriptin\n\n\n- batch features (constant simple)\n- dynamic feature (bottleneck of serving is hydration)\n-- caching top features (cache invalidation logic, ttl, etc)\n-- simple important\n\n\nModeling architecture:\n- Candidate generator + ranker (light ranker?)\n-- candidate genreator (colab filtering:  fast , simple, continual training WALS), content based filtering (cold start, feature enginering nedeed)\n-- two tower (cold start, fast, needs complicated serving, ANN)\n-- one tower for user + query (inference real time),\n-- MLP with same heads as main model, much less number of features\n(goal is to improve recall while latency budgets are met)\n-- loss can be simpler\n\n\n- single tower (heavy ranker)\n-- learning to rank point wise (simple training and practically safe)\n-- pairwise and listwise (lambdarank hinge loss, and lambda mart for NDCG loss)\n-- we can have a distilled light ranker (can help with serving bias)\n-- feature crosses (explicit, embedding based (XFM), DCN(embedding based)\n-- MLP (MMOE to deal with task competition)\n-- DCN V2 for efficient deep feature crosses\n-- neuroarchitectural search to generate explicit features\n(goal is to improve precision)\n\n-- reranker (business logic, freshness, diverstity, near duuplocate)\n\n\n\nModel training\n- Heavy skew (down sample majority class)\n- Focal loss to avoid loss from being dominated by majortiy class\n(what is it?)\n- Gradient blending to avoid loss from domiated from majority class\n- No caliberation needed\n\n\nEvaluation\noffline: \n- for model (each head AUC, weighted loss)\n- MAP (rank of list of results)\n- diversity gaurdrailed on quality (aggregated cosine similrity)\n\nOnline:\n- weighted sum of DS provided engagement score\n- CTR\n- dwell time\n- explicit feedback\n- LTV\n- gaurdrails on reports, dislike rate, negative comment rate.\n\n\n\n\nServing\n- serving efficiency\n-- distilating heavy ranker to a light ranker\n-- embedding quantization and size optimization for two tower\n-- quantization\n-- caching (spcecailly for hydration and features)\n-- ANN\n\n- freshness, diversity, populairty\n-- freshness: continual learning (avoid catastrophic forgetting with learning rate decay)\n-- diversity: non-diverse penalty\n \n\n\n\n\nDeployment\n- shadowing (offline verification)\n- canarying\n- A/B testing \n- holdback\n- possibly multi arm bandit (exploration rate fixed)\n\n\n\nAdvanced topic\n- bias (popularity, serving, position)\n-- popularity penalty\n-- epsilon greedy, \n-- add position as feautre and serve same at serivng\n\n- sampling \n- exploration vs exploitation\n\n- Cold start:\n-- both two tower and ranker can use context features\n-- do dropout of id features to avoid too much reliance\n-- fallback model for new users (trendy, popular)\n-- get users' early interest\n-- for new items (user a content based filtering model)\n","fontSize":20,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Design YT recommendation system:\n\nCQ:\n- How big is the catalouge? 1B\n- Multi lingual? yes\n- Is there a context (like video page), or is it on feed? Feed\n- Latency budget? 200ms\n- QPS? 50 k QPS\n- KPI: Video completion rate guardrail on churn rate?\n- Multi lingual videos. Yes\n- User video interactions (like, comment, watch, watch ratio, click,etc) available? Yes\n\nHigh level:\n- maximize user engagement on video catalogue\n- KPI watch time (dwell time- relevant (weighted sum of important signals)), guardrail on churn, \n- fast\n\nData engineering:\n- label: relevant metric (weighted sum of metrics) (give score to each)\n- w1 x like, w2 x comment sentiment, w3 x share, w4 x watch time, w5 x dwell time\n- negative samples, in session impressed by not engaged (per task)\n\n- features:\n-- user: user age, user demographic, user history, user embeddings (from a seperate user sequence model)\n-- user search history (embedding of queries aggregated), ids of videos (liked, shared, tc) also aggregated)\n\n- user id, user clusters (of video genre), user previous video id s aggreated embeding, \n-\nrequest:\n- context \n- TOTD, DOTW, device id,network id, phone type, phone version, \n\n\n video\n- video id (embedding)\n- video contnent (cleaning, decoding to frame, noramization, denoising)=> simclr, autoencoder\n-- video level models (3d transformer), or frame base (first one very expensive) - but done offline\n\n- video transcription: BERT\n- video genre (one hot)\n- video description (BERT, distilled bert)\n- video # like (bucketized, maybe after transform, it is right skwed)\n- video #  impression (bucketized)\n- video comments (BERT)\n- video age (for fresh results) (bucketized)\n- video channel id (embedding)\n- video channel genre (bucketized)\n- video channel num subscriptin\n\n\n- batch features (constant simple)\n- dynamic feature (bottleneck of serving is hydration)\n-- caching top features (cache invalidation logic, ttl, etc)\n-- simple important\n\n\nModeling architecture:\n- Candidate generator + ranker (light ranker?)\n-- candidate genreator (colab filtering:  fast , simple, continual training WALS), content based filtering (cold start, feature enginering nedeed)\n-- two tower (cold start, fast, needs complicated serving, ANN)\n-- one tower for user + query (inference real time),\n-- MLP with same heads as main model, much less number of features\n(goal is to improve recall while latency budgets are met)\n-- loss can be simpler\n\n\n- single tower (heavy ranker)\n-- learning to rank point wise (simple training and practically safe)\n-- pairwise and listwise (lambdarank hinge loss, and lambda mart for NDCG loss)\n-- we can have a distilled light ranker (can help with serving bias)\n-- feature crosses (explicit, embedding based (XFM), DCN(embedding based)\n-- MLP (MMOE to deal with task competition)\n-- DCN V2 for efficient deep feature crosses\n-- neuroarchitectural search to generate explicit features\n(goal is to improve precision)\n\n-- reranker (business logic, freshness, diverstity, near duuplocate)\n\n\n\nModel training\n- Heavy skew (down sample majority class)\n- Focal loss to avoid loss from being dominated by majortiy class\n(what is it?)\n- Gradient blending to avoid loss from domiated from majority class\n- No caliberation needed\n\n\nEvaluation\noffline: \n- for model (each head AUC, weighted loss)\n- MAP (rank of list of results)\n- diversity gaurdrailed on quality (aggregated cosine similrity)\n\nOnline:\n- weighted sum of DS provided engagement score\n- CTR\n- dwell time\n- explicit feedback\n- LTV\n- gaurdrails on reports, dislike rate, negative comment rate.\n\n\n\n\nServing\n- serving efficiency\n-- distilating heavy ranker to a light ranker\n-- embedding quantization and size optimization for two tower\n-- quantization\n-- caching (spcecailly for hydration and features)\n-- ANN\n\n- freshness, diversity, populairty\n-- freshness: continual learning (avoid catastrophic forgetting with learning rate decay)\n-- diversity: non-diverse penalty\n \n\n\n\n\nDeployment\n- shadowing (offline verification)\n- canarying\n- A/B testing \n- holdback\n- possibly multi arm bandit (exploration rate fixed)\n\n\n\nAdvanced topic\n- bias (popularity, serving, position)\n-- popularity penalty\n-- epsilon greedy, \n-- add position as feautre and serve same at serivng\n\n- sampling \n- exploration vs exploitation\n\n- Cold start:\n-- both two tower and ranker can use context features\n-- do dropout of id features to avoid too much reliance\n-- fallback model for new users (trendy, popular)\n-- get users' early interest\n-- for new items (user a content based filtering model)\n","autoResize":true,"lineHeight":1.25}],"appState":{"viewBackgroundColor":"#ffffff","lockedMultiSelections":{}},"files":{}}