name: Lighthouse CI

on:
  push:
    branches: [main]
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
      - '.github/workflows/lighthouse.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
      - '.github/workflows/lighthouse.yml'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g @lhci/cli
          npm install -g http-server

      - name: Start local server
        run: |
          http-server . -p 8080 &
          sleep 5

      - name: Run Lighthouse CI
        run: |
          lhci autorun --config=.lighthouserc.json || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Create Lighthouse config if not exists
        run: |
          if [ ! -f .lighthouserc.json ]; then
            cat > .lighthouserc.json << 'EOF'
          {
            "ci": {
              "collect": {
                "url": [
                  "http://localhost:8080/index.html",
                  "http://localhost:8080/leetcode.html",
                  "http://localhost:8080/ml-system-design.html",
                  "http://localhost:8080/behavioral.html",
                  "http://localhost:8080/cheatsheet.html",
                  "http://localhost:8080/about.html",
                  "http://localhost:8080/resources.html"
                ],
                "numberOfRuns": 1
              },
              "assert": {
                "assertions": {
                  "categories:performance": ["warn", {"minScore": 0.7}],
                  "categories:accessibility": ["error", {"minScore": 0.8}],
                  "categories:best-practices": ["warn", {"minScore": 0.8}],
                  "categories:seo": ["warn", {"minScore": 0.8}]
                }
              },
              "upload": {
                "target": "temporary-public-storage"
              }
            }
          }
          EOF
          fi

      - name: Run Lighthouse on local pages
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:8080/index.html
            http://localhost:8080/leetcode.html
            http://localhost:8080/ml-system-design.html
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Format Lighthouse Score
        id: format_lighthouse_score
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const results = ${{ steps.lighthouse.outputs.manifest }};
            const links = ${{ steps.lighthouse.outputs.links }};

            let comment = '## Lighthouse Results\n\n';
            comment += '| Page | Performance | Accessibility | Best Practices | SEO |\n';
            comment += '|------|-------------|---------------|----------------|-----|\n';

            if (results && Array.isArray(results)) {
              for (const result of results) {
                const url = new URL(result.url).pathname;
                const scores = result.summary;
                const getEmoji = (score) => score >= 0.9 ? 'ðŸŸ¢' : score >= 0.5 ? 'ðŸŸ¡' : 'ðŸ”´';

                comment += `| ${url} | ${getEmoji(scores.performance)} ${Math.round(scores.performance * 100)} | ${getEmoji(scores.accessibility)} ${Math.round(scores.accessibility * 100)} | ${getEmoji(scores['best-practices'])} ${Math.round(scores['best-practices'] * 100)} | ${getEmoji(scores.seo)} ${Math.round(scores.seo * 100)} |\n`;
              }
            }

            comment += '\n### Report Links\n';
            if (links) {
              for (const [url, link] of Object.entries(links)) {
                comment += `- [${new URL(url).pathname}](${link})\n`;
              }
            }

            core.setOutput('comment', comment);

      - name: Add Lighthouse summary
        run: |
          echo "## Lighthouse CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Lighthouse audits have been run on the main pages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
